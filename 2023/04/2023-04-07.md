# Fast triggering LED with DMA

Exercise in figuring out DMA chaining, turns out the terminology for this is a transaction in the local lingo. With code below LED flickered at about 10MHz so the DMA transfers running at about 20MHz, well in excess of what is needed to run 2 x DAC flat out.

Details:

- `0x41008000` is PORT address
- `0x41008000 | 0x80` is PORT B
- `0x41008000 | 0x80 | 0x1c` is pin PORT B TOGGLE register
- LED is on `PB01/D13` -> sent 0x2 to PORT B TOGGLE to switch

```python
# Blink the LED with DMA
#
# i.e. write the correct bit to the TGL register a few million times
# N.B. will involve DMA chaining and DMA enable / disable. LED on pin 2
# of B port

from machine import mem32, Pin
from uctypes import addressof

import time

led = Pin("D13", Pin.OUT)

buffer = bytearray(4)
address = addressof(buffer)
mem32[address] = 0x2

# get the DMA configured - depends on timer counter and global clock

DMAC_BASE = 0x4100A000

# SWRST of DMA controller
mem32[DMAC_BASE] = 0x1

# allocate part of the SRAM for DMAC working memory - each DMAC needs
# 4 words, and in the examples I looked at they needed to be 16-byte
# aligned but I have no idea if this is important - it turns out it
# probably is, so allocate extra space
dma_desc = bytearray(32 * 16)
dma_dwrb = bytearray(32 * 16)

DESC_BASE = addressof(dma_desc)
DWRB_BASE = addressof(dma_dwrb)

mem32[DMAC_BASE | 0x34] = DESC_BASE
mem32[DMAC_BASE | 0x38] = DWRB_BASE

# start actual DMA configuration - enable 0x2 and all priority?
mem32[DMAC_BASE | 0x0] = (0xf << 8) | 0x2

# select channel 0 - configure as transaction i.e. will send everything
# once the trigger arrives, and keep sending until the DMA chain expires
mem32[DMAC_BASE | 0x40] = 0x3 << 20

# channel zero configuration NN in top half, do not increment the source pointer
# or destination pointer and move 4 bytes, chain to #1
mem32[DESC_BASE] = (10000 << 16) | (0x2 << 8) | 0x1
mem32[DESC_BASE | 0x4] = address
mem32[DESC_BASE | 0x8] = 0x41008000 | 0x80 | 0x1c
mem32[DESC_BASE | 0xc] = DESC_BASE

# enable
mem32[DMAC_BASE | 0x40] |= 0x2

# trigger
mem32[DMAC_BASE | 0x10] = 0x1

# should run for a while
time.sleep(60)

# disable
mem32[DMAC_BASE | 0x40] &= 0xfffffffc
mem32[DMAC_BASE | 0x0] = 0x0

led.off()
```